<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
	<head>
		<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Health Messages Communication Website</title>
		<link rel="stylesheet" type="text/css" href="../../resources/css/font-awesome/css/font-awesome.min.css">
		<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="../../resources/js/bootstrap/css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="../../resources/js/jqueryui/css/ui-lightness/jquery-ui-1.9.2.custom.css">
		<link rel="stylesheet" type="text/css" href="../../resources/css/blue.css">
		<link rel="stylesheet" type="text/css" href="../../resources/css/new.css">
		<link rel="stylesheet" type="text/css" href="../../resources/css/toastr.css" />
	</head>
	<body>
		<div class="modal fade" id="modal_dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title"></h4>
					</div>
					<div class="modal-body"></div>
					<div id="modal-footer hidden"  class="col-md-12"></div>
				</div>
			</div>
		</div>
		<div id="wrapper">
			<header id="header">
				<a id="top-bar-toggle" class="navbar-toggle collapsed" data-target=".top-bar-collapse" data-toggle="collapse" href="javascript:;"><i class="fa fa-cog"></i></a>
				<a id="sidebar-toggle" class="navbar-toggle collapsed" data-target=".sidebar-collapse" data-toggle="collapse" href="javascript:;"><i class="fa fa-reorder"></i></a>
			</header>
			<nav id="top-bar" class="collapse top-bar-collapse">
				<ul class="nav navbar-nav pull-left">
					<li><a href=""><i class="fa fa-home"></i>Home</a></li>
				</ul>
				<ul class="nav navbar-nav pull-right">
					<li class="dropdown">
						<a class="dropdown-toggle" href="javascript:;" data-toggle="dropdown"><i class="fa fa-user"></i> <span id="loggedAs"></span><span class="caret"></span></a>
						<ul class="dropdown-menu" role="menu">
							<li><a href="#" onClick="logout();"><i class="fa fa-sign-out"></i>Logout</a></li>
							<li><a href="#" onClick="setChangePasswordForm();"><i class="fa fa-key"></i>Change Password</a></li>
						</ul>
					</li>
				</ul>
			</nav>
			<div id="sidebar-wrapper" class="collapse sidebar-collapse">
				<div id="search">
					<form>
						<input id="search" class="form-control input-sm" type="text" placeholder="Search..." name="search">
						<button id="search-btn" class="btn" type="submit"><i class="fa fa-search"></i></button>
					</form>
				</div>
				<nav id="sidebar">
					<ul id="main-nav" class="open-active">
						<li><a href="../"><i class="fa fa-dashboard"></i>Dashboard</a></li>
						<li class="active"><a href=""><i class="fa fa-bullhorn"></i> Campaigns</a></li>
						<li><a href="../../surveys/"><i class="fa fa-check-square-o"></i> Surveys</a></li>
						<li><a href="../../news/"><i class="fa fa-globe"></i> News</a></li>
						<li><a href="../../topics/"><i class="fa fa-file-text-o"></i> Health Topics</a></li>
						<li><a href="../../events/"><i class="fa fa-calendar"></i> Events</a></li>
<!-- 						<li><a href="../reports/"><i class="fa fa-pencil"></i> Reports</a></li> -->
					</ul>
				</nav>
			</div>
			<div id="content">
				<div id="content-header"><h1>Dashboard</h1></div>
				<div id="content-container"></div>
			</div>
		</div>
		<footer class="bs-footer clearFix" role="contentinfo"><ul class="nav pull-right"><li> Copyright &copy; 2013, Healthcomm.ru.ac.za. </li></ul></footer>
		<script type="text/javascript" src="../../resources/js/jquery-1.10.2.min.js"></script>
		<script type="text/javascript" src="../../resources/js/jqueryui/js/jquery-ui-1.9.2.custom.min.js"></script>
		<script type="text/javascript" src="../../resources/js/bootstrap/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="../../resources/js/jquery.dataTables.min.js"></script>
		<script type="text/javascript" src="../../resources/js/DT_bootstrap.js"></script>
		<script type="text/javascript" src="../../resources/js/jquery.tableCheckable.js"></script>
		<script type="text/javascript" src="../../resources/js/jquery.icheck.min.js"></script>
		<script type="text/javascript" src="../../resources/js/tiny_mce/jquery.tinymce.js"></script>
		<script type="text/javascript" src="../../resources/js/jquery.validate.min.js"></script>
		<script type="text/javascript" src="../../resources/js/toastr.js"></script>
		<script type="text/javascript" src="../../resources/js/paging.js"></script>
		<script type="text/javascript" src="../../resources/js/sha256.js"></script>
		<script type="text/javascript" src="../../resources/js/enc-base64-min.js"></script>
		<script type="text/javascript" src="../../resources/js/jquery.cookie.js"></script>
		<script type="text/javascript" src="../../resources/js/store.js"></script>
		<script type="text/javascript" src="../../resources/js/util.js"></script>
		<script type="text/javascript">
		
			if (!is_logged_in()) window.location = '../home/';
	
			var storedUser = store.get('dashboard-currentUser')
			if (storedUser) {
				var user = JSON.parse(storedUser)
				$('#loggedAs').html(' Logged in as ' + user.firstName + ' ' + user.lastName);
			}
			
			$(function() {
				$(".dropdown-menu li a:last").click(function() {
					$(".modal-title").html("Change Password");
					$(".modal-body").html(
						'<form id="frmChangePassword" role="form">' +
							'<div class="form-group">' +
								'<label for="currentPassword">Current Password</label>' +
							    '<input type="password" class="form-control" name="currentPassword" id="currentPassword" placeholder="Current Password">' +
							'</div>' +
							'<div class="form-group">' +
								'<label for="newPassword">New Password</label>' +
								'<input type="password" class="form-control" name="newPassword" id="newPassword" placeholder="New Password">' +
							'</div>' +
							'<div class="form-group">' +
								'<label for="confirmNewPassword">Confirm New Password</label>' +
								'<input type="password" class="form-control" name="confirmNewPassword" id="confirmNewPassword" placeholder="Confirm New Password">' +
							'</div>' +
							'<button type="submit" id="btnChangePassword" class="btn btn-primary">Submit</button>' +
						'</form>'
					);
					$('#modal_dialog').modal('show');
					$("#btnChangePassword").click(function() {
						$("#frmChangePassword").validate({
							rules: {
								currentPassword: {
									required: true,
									minlength: 8
								},
								newPassword: {
									required: true,
									minlength: 8
								},
								confirmNewPassword: {
									required: true,
									minlength: 8
								}
							},
							submitHandler: function() {
								if ($('#newPassword').val().trim() != $('#confirmNewPassword').val().trim()) {
									toastr.error('Passwords do not match');
									return false;
								}
								console.log('Resetting password...');
								resetPassword($('#currentPassword').val().trim(), $('#newPassword').val().trim(), function(error) {
									if (!error) {
										toastr.success('Password reset successfully');
										closeModal();
									} else {
										toastr.error(error.responseJSON.applicationMessage);
										clearInput();
									}
								})
							}
						});
					});
				});
				
				getAllCampaigns();
	
				function getAllCampaigns () {
					console.log('Getting all campaigns...');
					$.ajax({
						type: 'GET',
						url: rootURL + 'campaign',
						dataType: "json",
						ifModified: true,
						success: function(data) {
							renderCampaignList(data);
						},
						error: function() {
							toastr.error('Error getting all the campaigns');
						}/*,
						complete: function() {
							setTimeout(getAllCampaigns(), 3000);
						}*/
					});
				}
				
				var renderCampaignList = function( data ) {
					$( '#content-container' ).html(
						'<div class="row">' +
							'<div class="col-md-12">' +
								'<div class="portlet">' +
									'<div id="srv-portlet-header"class="portlet-header"><h3><i class="fa fa-bullhorn"></i> Campaigns</h3></div>' +
										'<div class="portlet-content">' +
											'<div>' +
												'<span class="btn" id="btnAdd"><i class="fa fa-plus fa-lg"></i> Add</span>' +
												'<span class="btn" id="btnDeactivate"><span class="fa-stack"><i class="fa fa-bullhorn fa-stack-1x"></i><i class="fa fa-ban fa-stack-2x text-danger"></i></span> Stop</span>' +
												'<span class="btn" id="btnActivate"><i class="fa fa-check fa-lg"></i> Restart</span>' +
												'<span class="btn" id="btnDelete"><i class="fa fa-trash-o fa-lg"></i> Delete</span>' +
												'<span class="btn" id="btnArchive"><i class="fa fa-archive fa-lg"></i> Archive</span>' +
												'<span class="btn" id="btnListCampaigns"><i class="fa fa-arrow-left fa-lg"></i> Back to Campaigns</span>' +
											'</div>' +
											'<div id="portlet-main-content">' +
												'<div class="table-responsive">' +
													'<table id="tblCampaigns" class="table table-striped table-bordered table-hover table-highlight table-checkable">' +
														'<thead>' +
															'<tr>' +
																'<th><input id="checkall" type="checkbox" class="icheck-all"></th>' +
																'<th>VIEW MORE</th>' +
																'<th>NAME</th>' +
																'<th>CREATION DATE</th>' +								
																'<th>START DATE</th>' +
																'<th>END DATE</th>' +
																'<th>STATUS</th>' +
																'<th>AIM</th>' +
																'<th>DESCRIPTION</th>' +
																'<th>SLOGAN</th>' +
																'<th>TARGET</th>' +
																'<th>ID</th>' +
																'<th>ACTIONS</th>' +
															'</tr>' +
														'</thead>' +
														'<tbody></tbody>' +
														'<tfoot>' +
															'<tr>' +
																'<th><input class="form-control input-sm hide" type="text" placeholder=" "></th>' +
																'<th><input class="form-control input-sm hide" type="text" placeholder=" "></th>' +
																'<th><input class="form-control input-sm show" type="text" placeholder="Search by Name"></th>' +
																'<th><input class="form-control input-sm show" type="text" placeholder="Search by Creation Date"></th>' +
																'<th><input class="form-control input-sm show" type="text" placeholder="Search by Start Date"></th>' +
																'<th><input class="form-control input-sm show" type="text" placeholder="Search by End Date"></th>' +
																'<th><input class="form-control input-sm show" type="text" placeholder="Search by Status"></th>' +
																'<th><input class="form-control input-sm hide" type="text" placeholder="Aim"></th>' +
																'<th><input class="form-control input-sm hide" type="text" placeholder="Description"></th>' +
																'<th><input class="form-control input-sm hide" type="text" placeholder="Slogan"></th>' +
																'<th><input class="form-control input-sm hide" type="text" placeholder="Target"></th>' +
																'<th><input class="form-control input-sm hide" type="text" placeholder="ID"></th>' +
																'<th><input class="form-control input-sm hide" type="text" placeholder="Actions"></th>' +
															'</tr>' +
														'</tfoot>' +
													'</table>' +
												'</div>' +
											'</div>' +
										'</div>' +
									'</div>' +
								'</div>' +
							'</div>' +
						'</div>');
					$('#btnListCampaigns').hide();
					var campaignList = data instanceof Array ? data : [data];
					$.each(campaignList, function(index, campaign) {
						var now = new Date();
						var currentDate = $.datepicker.formatDate('yy-mm-dd', new Date(now.getFullYear(), now.getMonth(), now.getDate()));
						var startDate = $.datepicker.formatDate('yy-mm-dd', new Date(campaign[2]));;
						var endDate = $.datepicker.formatDate('yy-mm-dd', new Date(campaign[3]));
						var status = campaign[4] == 'Archived' ? campaign[4] : (campaign[4] == 'Inactive' ? campaign[4] : (endDate < currentDate ? 'Finished' : (startDate <= currentDate ? 'Running' : 'Active')));
						var displayStatus = campaign[4] == 'Archived' ? 'warning' : (campaign[4] == 'Inactive' ? 'danger' : (endDate < currentDate ? 'success' : (startDate < currentDate ? 'warning' : 'active')));
						var labelStatus = campaign[4] == 'Archived' ? 'default' : (campaign[4] == 'Inactive' ? 'primary' : (endDate < currentDate ? 'success' : (startDate < currentDate ? 'secondary' : 'success')));
						var target = campaign[8] == null ? '' : campaign[8];
						$('#content-container tbody').append('<tr id="tr-'+ campaign[9] +'" class="'+ displayStatus+'">' +
							'<td><input id="'+ campaign[9]+'" type="checkbox" class="icheck-input" data-currentDate="'+ currentDate +'" data-startDate="'+ startDate +'" data-endDate="'+ endDate +'"></td>' +
							'<td class="text-center"><i class="fa fa-plus-circle fa-lg view-more"></i></td>' +
							'<td>'+ campaign[0] +'</td>' +
							'<td>' + $.datepicker.formatDate('yy-mm-dd', new Date(campaign[1])) + '</td>' +
							'<td>' + $.datepicker.formatDate('yy-mm-dd', new Date(campaign[2])) + '</td>' +
							'<td>' + $.datepicker.formatDate('yy-mm-dd', new Date(campaign[3])) + '</td>' +
							'<td><span class=" label label-'+ labelStatus +'">' + status + '</span></td>' +
							'<td>'+ campaign[5] +'</td>' +
							'<td>'+ campaign[6] +'</td>' +
							'<td>'+ campaign[7] +'</td>' +
							'<td>'+ target +'</td>' +
							'<td>'+ campaign[9] +'</td>' +
							'<td style="white-space:nowrap">' +
								'<span class="btn btn-xs btn-info" id="message-' + campaign[9] + '"><i title="Add Campaign Messages" class="fa fa-envelope-o fa-1x"></i></span>' +
								'<span class="btn btn-xs btn-info" id="target-' + campaign[9] + '"><i title="Set Target" class="fa fa-bullseye fa-1x"></i></span>' +
								'<span class="btn btn-xs btn-info" id="update-' + campaign[9] + '"><i title="Edit Campaign" class="fa fa-pencil fa-1x"></i></span>' +
								'<span class="btn btn-xs btn-danger" id="delete-' + campaign[9] + '"><i title="Delete Campaign" class="fa fa-trash-o fa-1x"></i></span>' +
								'<span class="btn btn-xs btn-warning" id="deactivate-' + campaign[9] + '"><i title="Stop Campaign" class="fa fa-ban fa-1x"></i></span>' +
								'<span class="btn btn-xs btn-success" id="activate-' + campaign[9] + '"><i title="Restart Campaign" class="fa fa-check fa-1x"></i></span>' +
								'<span class="btn btn-xs btn-danger" id="archive-' + campaign[9] + '"><i title="Archive Campaign" class="fa fa-archive fa-1x"></i></span>' +
								'<span class="btn btn-xs btn-info" id="publish-' + campaign[9] + '"><i title="Publish Campaign" class="fa fa-upload fa-1x"></i></span>' +
							'</td>' +
						'</tr>');
						setupActions(campaign[9], status);
						$('#message-' + campaign[9]).click(function() {
							getAllCampaignMessages(campaign[9]);
						});
						$('#target-' + campaign[9]).click(function() {
							console.log('Getting campaign targets...');
							$.ajax({
								type: 'GET',
								url: rootURL + 'campaign/'+ campaign[9] +'/target',
								dataType: 'json',
								statusCode: {
									200: function(target) {
										$('#btnListCampaigns').show();
										deactivateMenuButtons();
										setupTargetPage(target, campaign[9], 'Setup campaign target', 'Campaign');
									},
									500: function() {
										toastr.error('Error getting campaign targets');
									}
								}
							});
						});
						$('#deactivate-' + campaign[9]).click(function() {
							deactivateCampaign(campaign[9], currentDate, startDate, endDate);
						});			
						$('#activate-' + campaign[9]).click(function() {
							activateCampaign(campaign[9], currentDate, startDate, endDate);
						});			
						$('#archive-' + campaign[9]).click(function() {
							archiveCampaign(campaign[9]);
						});			
						$('#update-' + campaign[9]).click(function() {
							setupCampaignForm(campaign);
						});
						$('#delete-' + campaign[9]).click(function() {
							setupDeleteCampaign(campaign[9]);
						});
						$('#publish-' + campaign[9]).click(function() {
							var response = confirm('Are you sure you want to publish the campaign?');
							if (response == false) return false;
							console.log('Getting campaign details with id '+ campaign[9]);
							$.ajax({
								type: 'GET',
								url: rootURL + 'campaign/'+ campaign[9],
								dataType: 'json',
								success: function(campaign) {
									console.log('Sending campaign details to TeleWeaver...');
									$.ajax({
										type: 'POST',
										contentType: 'application/json',
										crossDomain: true,
										url: teleWeaverURL + 'campaign/campaign/',
										data: campaignDataToJSON(campaign),
										dataType: 'application/json',
										success: function() {
											toastr.success('Campaign published successfully');
										},
										error: function() {
											toastr.error('Error publishing a campaign');
										}
									});
								},
								error: function() {
									toastr.error('Error getting campaign details');
								}
							});
						});
					});
					campaignDatatableSettings();
					$('.table-responsive select').on('change', function() {
						campaignDatatableSettings();
					});
					$('.pagination li a').on('click', function() {
						campaignDatatableSettings();
					});
					$('#checkall').on('ifChecked', function(event){
						$('.icheck-input').iCheck('check');
					});
					
					$('#checkall').on('ifUnchecked', function(event){
						$('.icheck-input').iCheck('uncheck');
					});
	
					$('#btnAdd').click(function() {
						setupCampaignForm(null);
					});
					
					$('#btnDeactivate').click(function() {
						var checked_checkboxes = $('.icheck-input:checked');
						if (checked_checkboxes.length == 0) {
							alert('Please select campaigns to stop');
							return false;
						}
						var response = confirm('Are you sure you want to stop the selected campaigns?');
						if (response == false) return false;
						checked_checkboxes.each(function(index) {
							updateCampaign($(this).attr('id'), status.Inactive, $(this).data('currentDate'), $(this).data('startDate'), $(this).data('endDate'));
						});
						uncheckCheckboxes($('.table-responsive tbody td div'));
					});	
					
					$('#btnActivate').click(function() {
						var checked_checkboxes = $('.icheck-input:checked');
						if (checked_checkboxes.length == 0) {
							alert('Please select campaigns to activate');
							return false;
						}
						var response = confirm('Are you sure you want to restart the selected campaigns?');
						if (response == false) return false;
						checked_checkboxes.each(function(index) {
							updateCampaign($(this).attr('id'), status.Active, $(this).attr('data-currentDate'), $(this).attr('data-startDate'), $(this).attr('data-endDate'));
						});
						uncheckCheckboxes($('.table-responsive tbody td div'));
					});	
					
					$('#btnDelete').click(function() {
						var checked_checkboxes = $('.icheck-input:checked');
						if (checked_checkboxes.length == 0) {
							alert('Please select campaigns to delete');
							return false;
						}
						var response = confirm('Are you sure you want to delete the selected campaigns?');
						if (response == false) return false;
						checked_checkboxes.each(function(index) {
							deleteCampaign($(this).attr('id'));
						});
					});
					
					$('#btnArchive').click(function() {
						var checked_checkboxes = $('.icheck-input:checked');
						if (checked_checkboxes.length == 0) {
							alert('Please select campaigns to archive');
							return false;
						}
						var response = confirm('Are you sure you want to archive the selected campaigns?');
						if (response == false) return false;
						checked_checkboxes.each(function(index) {
							updateCampaign($(this).attr('id'), status.Archived, $(this).data('currentDate'), $(this).data('startDate'), $(this).data('endDate'));
						});
						uncheckCheckboxes($('.table-responsive tbody td div'));
					});
					$('#btnListCampaigns').click(function() {
						getAllCampaigns();
					});
				}
				
				var campaignDataToJSON = function(campaign) {
					var arrMessages1 = Array();
					var arrMessages2 = {};
					for (var i=0; i<campaign.messages.length; i++) {
						arrMessages2["id"] = null;
						arrMessages2["uuid"] = campaign.messages[i].uuid;
						arrMessages2["item"] = campaign.messages[i].item;
						arrMessages2["description"] = campaign.messages[i].description;
						arrMessages1[i] = JSON.stringify(arrMessages2);
					}
					var arrMessages = cleanArrMessages(arrMessages1);
					return JSON.stringify({
						id: campaign.id,
						uuid: campaign.uuid,
						title: campaign.title,
						aim: campaign.aim,
						description: campaign.description,
						slogan: campaign.slogan,
						creationDate: campaign.creationDate,
						startDate: campaign.startDate,
						endDate: campaign.endDate,
						status: campaign.status,
						messages: arrMessages,
						target: {
							dateOfBirthFrom: campaign.target == null ? null : campaign.target.dateOfBirthFrom,
							dateOfBirthTo: campaign.target == null ? null : campaign.target.dateOfBirthTo,
							gender: campaign.target == null ? null : campaign.target.sex,
							occupation: campaign.target == null ? null : campaign.target.occupation,
							maritalStatus: campaign.target == null ? null : campaign.target.maritalStatus,
							sexOrientation: campaign.target == null ? null : campaign.target.sexOrientation,
							address: {
								province: campaign.target == null ? null : campaign.target.address.province,
								district: campaign.target == null ? null : campaign.target.address.district,
								municipality: campaign.target == null ? null : campaign.target.address.municipality,
								village: campaign.target == null ? null : campaign.target.address.village
							}
						}
					});
				}
				
				var cleanArrMessages = function(arrayMessages) {
					var arrLength = arrayMessages.length;
					var finalArrMessages = Array();
					for (var i=0; i<arrLength; i++) {
						finalArrMessages[i] = JSON.parse(arrayMessages[i]); 
					}
					return finalArrMessages;
				}
				
				var campaignDatatableSettings = function() {
					var oTable = $('#tblCampaigns').dataTable( {
					    "bRetrieve": true,
						'aoColumnDefs': [
						                 { 'bVisible': false, 'aTargets': [ 3, 7, 8, 9, 10, 11 ] },
						                 { "bSortable": false, "aTargets": [ 0, 1, 12 ] }
						],
				        "aaSorting": [[3, 'desc']],
				        "iDisplayLength": 10
				    });
					
					$('.icheck-input').iCheck({
						checkboxClass: 'icheckbox_minimal-blue'
					});
					
					$('.icheck-all').iCheck({
						checkboxClass: 'icheckbox_minimal-blue'
					});
				    
					$('.dataTables_filter input').prop ('placeholder', 'Search...');
				    
				    $('tfoot input').keyup(function() {
				    	oTable.fnFilter(this.value, $('tfoot input').index(this));
				    });
				     
				    /* Add event listener for opening and closing details
				     * Note that the indicator for showing which row is open is not controlled by DataTables,
				     * rather it is done here*/
				     
				    $('.view-more').click(function () {
				        var nTr = $(this).parents('tr')[0];
				        if ( oTable.fnIsOpen(nTr) )
				        { 
				            $(this).attr('class', 'fa fa-plus-circle fa-lg');
				            oTable.fnClose( nTr );
				        }
				        else
				        { 
				        	$(this).attr('class', 'fa fa-minus-circle fa-lg');
				            oTable.fnOpen( nTr, createCampaignHiddenDetails(oTable, nTr), 'details' );
				        }
				    });
				}
				
				var createCampaignHiddenDetails = function(oTable, nTr) {
					var aData = oTable.fnGetData( nTr );
				    var sOut = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">';
				    sOut += '<tr><td>Slogan:</td><td>'+aData[9]+'</td></tr>';
				    sOut += '<tr><td>Aim:</td><td>'+aData[7]+'</td></tr>';
				    sOut += '<tr><td>Description:</td><td>'+aData[8]+'</td></tr>';
				    sOut += '</table>';
				    return sOut;
				}
				
				var setupCampaignForm = function(campaign) {
					$('#btnListCampaigns').show();
					deactivateMenuButtons();
					$('#portlet-main-content').html(
						'<form id="frmCampaign" role="form">' +
							'<div class="form-group col-md-12"><label for="name">Title</label><input type="text" name="name" id="name" class="form-control"></div>' +
							'<div class="form-group col-md-12"><label for="startDate">Start Date</label><input type="text" name="startDate" id="startDate" class="form-control"></div>' +
							'<div class="form-group col-md-12"><label for="endDate">End Date</label><input type="text" name="endDate" id="endDate" class="form-control"></div>'  +
							'<div class="form-group col-md-12"><label for="slogan">Slogan</label><input type="text" name="slogan" id="slogan" class="form-control"></div>' +
							'<div class="form-group col-md-12"><label for="aim">Aim</label><textarea name="aim" id="aim" class="form-control tinymce" rows="3"></textarea></div>' +
							'<div class="form-group col-md-12"><label for="description">Description</label><textarea name="description" id="description" class="form-control tinymce" rows="3"></textarea></div>' +
							'<div class="form-group col-md-12"></div>' +
						'</form>'
					);
					applyTinyMCE();
					$("input#startDate").datepicker({ dateFormat: "yy-mm-dd" });
					$("input#endDate").datepicker({ dateFormat: "yy-mm-dd" });
					if (campaign != null) {
						var campaignId = campaign[9] == null ? campaign[9] : campaign[9];
						$('#name').val(campaign[0] == null ? campaign.name : campaign[0]);
						$('#slogan').val(campaign[7] == null ? campaign.slogan : campaign[7]);
						$('#aim').val(campaign[5]);
						$('#description').val(campaign[6] == null ? campaign.description : campaign[6]);
						$('#startDate').val($.datepicker.formatDate('yy-mm-dd', new Date(campaign[2] == null ? campaign.startDate : campaign[2])));
						$('#endDate').val($.datepicker.formatDate('yy-mm-dd', new Date(campaign[3] == null ? campaign.endDate : campaign[3])));
						$('#portlet-header').html('<h3><i class="fa fa-bullhorn"></i> Update Campaign</h3>');
						$('#frmCampaign div:last').html('<button type="submit" id="btnUpdate" class="btn btn-primary">Update</button>');
						$('#btnUpdate').click(function() {
							$('#frmCampaign').validate({
								rules: {
									name: 'required',
									slogan: 'required',
									startDate: 'required',
									endDate: 'required'
								},
								submitHandler: function() {
									var now = new Date();
									var currentDate = $.datepicker.formatDate('yy-mm-dd', new Date(now.getFullYear(), now.getMonth(), now.getDate()));
									var startingDate = $('#startDate').datepicker({ dateFormat: 'yy-mm-dd' }).val().trim();
									var endingDate = $('#endDate').datepicker({ dateFormat: 'yy-mm-dd' }).val().trim();
									if (startingDate > endingDate) {
										alert('Start date cannot be greater than end date');
										return false;
									} else if (startingDate == endingDate) {
										var response = confirm('Are you sure the start date is the same as the end date?');
										if (response == false) return false;
									}
									if ($('#aim').val().trim() == '' || $('#description').val().trim() == '') {
										toastr.error('Slogan, aim and description can never be empty');
										return false;
									}
									console.log('Updating campaign with id ' + campaignId);
									$.ajax({
										type: 'PUT',
										contentType: 'application/json',
										url: rootURL + 'campaign/' + campaignId,
										dataType: 'json',
										data: campaignFormToJSON(campaignId),
										statusCode: {
											200: function() {
												toastr.success('Campaign updated succesfully');
											}
										}
									});
								},
								invalidHandler: function(event, validator) {
									displayFormInputError(event, validator);
								}
							});
						});
					} else {
						$('#frmCampaign div:last').html('<button type="submit" id="btnSave" class="btn btn-primary">Save and set Target</button>' +
							'<button type="button" id="btnCancel" class="btn btn-primary" style="float: right;">Cancel</button>'
						);
						$('#portlet-header').html('<h3><i class="fa fa-bullhorn"></i> Add Campaign</h3>');
						$("#btnCancel").click(function() {
							getAllCampaigns();
						});
						$('#btnSave').click(function() {
							var now = new Date();
							var currentDate = $.datepicker.formatDate('yy-mm-dd', new Date(now.getFullYear(), now.getMonth(), now.getDate()));
							var startingDate = $('#startDate').datepicker({ dateFormat: 'yy-mm-dd' }).val().trim();
							var endingDate = $('#endDate').datepicker({ dateFormat: 'yy-mm-dd' }).val().trim();
							if (startingDate < currentDate) {
								alert('Start date should be greater or equal to today\'s date');
								return false;
							} else if (startingDate > endingDate) {
								alert('Start date cannot be greater than end date');
								return false;
							} else if (startingDate == endingDate) {
								var response = confirm('Are you sure the start date is the same as the end date?');
								if (response == false) return false;
							}
							if ($('#aim').val().trim() == '' || $('#description').val().trim() == '') {
								toastr.error('Slogan, aim and description can never be empty');
								return false;
							}
							$('#frmCampaign').validate({
								rules: {
									name: 'required',
									startDate: 'required',
									endDate: 'required',
									slogan: 'required'
								},
								submitHandler: function() {
									console.log('Adding campaign...');
									$.ajax({
										type: 'POST',
										contentType: 'application/json',
										url: rootURL + 'campaign',
										dataType: 'json',
										data: campaignFormToJSON(null),
										success: function(campaign) {
											toastr.success("Campaign saved successfully. Please proceed to add campaign targets");
											setupTargetPage(null, campaign.id, "Setup Campaign Target", "Campaign")
										},
										error: function() {
											toastr.error("Error saving a campaign");
										}
									});
								},
								invalidHandler: function(event, validator) {
									displayFormInputError(event, validator);
								}
							});
						});
					}
				}
	
				var campaignFormToJSON = function (campaignId) {
					return JSON.stringify({
						id: campaignId,
						title: $('#name').val().trim(),
						aim: $('#aim').val().trim(),
						description: $('#description').val().trim(),
						slogan: $('#slogan').val().trim(),
						startDate: $('#startDate').val().trim(),
						endDate: $('#endDate').val().trim()
					});
				}
				
				var deactivateCampaign = function(campaignId, currentDate, startDate, endDate) {
					var response = confirm('Are you sure you want to stop the campaign?');
					if (response == false) return false;
					console.log('Deactivating a campaign with id ' + campaignId);
					updateCampaign(campaignId, status.Inactive, currentDate, startDate, endDate);
				}
				
				var activateCampaign = function(campaignId, currentDate, startDate, endDate) {
					var response = confirm('Are you sure you want to restart the campaign');
					if (response == false) return false;
					console.log('Restarting a campaign');
					updateCampaign(campaignId, status.Active, currentDate, startDate, endDate);
				}
				
				var archiveCampaign = function(campaignId) {
					var response = confirm('Are you sure you want to archive the campaign');
					if (response == false) return false;
					console.log('Archiving a campaign');
					updateCampaign(campaignId, status.Archived);
				}
				
				var updateCampaign = function(campaignId, status, currentDate, startDate, endDate) {
					$.ajax({
						type: 'PUT',
						contentType: 'application/json',
						url: rootURL + 'campaign/' + campaignId + '/status/' + status,
						dataType: 'json',
						success: function() {
							var cmpStatus = status;
							if (status == "Active") {
								if (endDate < currentDate) cmpStatus = "Finished"
								if (startDate <= currentDate) cmpStatus = "Running"
							}
							var labelStatus = status == 'Archived' ? 'default' : (status == 'Inactive' ? 'primary' : (endDate < currentDate ? 'success' : (startDate < currentDate ? 'secondary' : 'secondary')));
							$('#tr-'+campaignId+' td:eq('+5+') span').attr('class', 'label label-'+ labelStatus).html(cmpStatus);
							var displayStatus = status == 'Archived' ? 'warning' : (status == 'Inactive' ? 'danger' : (endDate < currentDate ? 'success' : (startDate < currentDate ? 'warning' : 'active')));
							$('#tr-'+ campaignId).attr('class', displayStatus);
							console.log("The campaaign status is : " + cmpStatus + " and " + status);
							setupActions(campaignId, cmpStatus);
							uncheckCheckboxes($('.table-responsive tbody td'));
						},
						error: function() {
							toastr.error("Error updating campaign status")
						}
					});		
				}
				
				var setupDeleteCampaign = function(campaignId) {
					var response = confirm('Are you sure you want to delete the campaign?');
					if (response == false) return false;
					console.log('Deleting a campaign with id ' + campaignId);
					deleteCampaign(campaignId);
				}
				
				var deleteCampaign = function(campaignId) {
					$.ajax({
						type: 'DELETE',
						url: rootURL + 'campaign/' + campaignId,
						statusCode: {
							200: function() {
								getAllCampaigns();
							}
						}
					});		
				}
				
				var getAllCampaignMessages = function(campaignId) {
					console.log('Getting messages for campaign with id ' + campaignId);
					$.ajax({
						type: 'GET',
						url: rootURL + 'campaign/' + campaignId + '/message',
						dataType: 'json',
						success: function(data) {
							displayCampaignMessages(data, campaignId);
						},
						error: function() {
							toastr.error('Error occured while getting campaign messages');
						}
					});
				}
				
				var displayCampaignMessages = function(data, campaignId) {
					$( '#content-container' ).html(
							'<div class="row">' +
								'<div class="col-md-12">' +
									'<div class="portlet">' +
										'<div id="srv-portlet-header"class="portlet-header"><h3><i class="fa fa-bullhorn"></i> Campaign Messages</h3></div>' +
											'<div class="portlet-content">' +
												'<div>' +
													'<span class="btn" id="btnAdd"><i class="fa fa-plus fa-lg"></i> Add</span>' +
													'<span class="btn" id="btnDelete"><i class="fa fa-trash-o fa-lg"></i> Delete</span>' +
													'<span class="btn" id="btnListMessages"><i class="fa fa-arrow-left fa-lg"></i> Back to Messages</span>' +
													'<span class="btn" id="btnListCampaigns"><i class="fa fa-arrow-left fa-lg"></i> Back to Campaigns</span>' +
												'</div>' +
												'<div id="portlet-main-content">' +
													'<div class="table-responsive">' +
														'<table id="tblMessages" class="table table-striped table-bordered table-hover table-highlight table-checkable">' +
															'<thead>' +
																'<tr>' +
																	'<th><input id="checkall" type="checkbox" class="icheck-input"></th>' +
																	'<th>MESSAGE</th>' +
																	'<th>DESCRIPTION</th>' +
																	'<th>ID</th>' +
																	'<th>ACTIONS</th>' +
																'</tr>' +
															'</thead>' +
															'<tbody></tbody>' +
															'<tfoot>' +
																'<tr>' +
																	'<th><input class="form-control input-sm hide" type="text" placeholder=" "></th>' +
																	'<th><input class="form-control input-sm show" type="text" placeholder="Message"></th>' +
																	'<th><input class="form-control input-sm hide" type="text" placeholder=""></th>' +
																	'<th><input class="form-control input-sm hide" type="text" placeholder=""></th>' +
																	'<th><input class="form-control input-sm hide" type="text" placeholder=""></th>' +
																'</tr>' +
															'</tfoot>' +
														'</table>' +
													'</div>' +
												'</div>' +
											'</div>' +
										'</div>' +
									'</div>' +
								'</div>' +
							'</div>');
					$('#btnListMessages').hide();
					$('#btnListCampaigns').show();
					activateMenuButtons();	
					var messageList = data instanceof Array ? data : [data];
					$.each(messageList, function(index, message) {
						$('#content-container tbody').append(
							'<tr id="tr-'+message[2]+'">' +
								'<td><input type="checkbox" id="'+message[2]+'" class="icheck-input"></td>' +
								'<td>'+message[0]+'</td>' +
								'<td>'+message[1]+'</td>' +
								'<td>'+message[2]+'</td>' +
								'<td>' +
									'<span class="btn btn-xs btn-info" id="update-'+message[2]+'"><i class="fa fa-pencil fa-1x"></i></span>' +
									'<span class="btn btn-xs btn-danger" id="delete-'+message[2]+'"><i class="fa fa-trash-o fa-1x"></i></span>' +
								'</td>' +
							'</tr>'
						);
						$('#update-' + message[2]).click(function() {
							$('#btnListMessages').show();
							$('#btnListCampaigns').hide();
							setupMessageForm(message, campaignId);
						});
						$('#delete-' + message[2]).click(function() {
							var response = confirm('Are you sure you want to delete the message');
							if (response == false) return false;
							console.log('Deleting a message with id ' + message[2]);				
							deleteCampaignMessages(message[2], campaignId);
						});
					});
					messageDatatableSettings();
					$('.table-responsive select').on('change', function() {
						messageDatatableSettings();
					});
					$('#checkall').on('ifChecked', function(event){
						$('.icheck-input').iCheck('check');
					});
					
					$('#checkall').on('ifUnchecked', function(event){
						$('.icheck-input').iCheck('uncheck');
					});
					$('#btnAdd').click(function() {
						$('#btnListMessages').show();
						$('#btnListCampaigns').hide();
						setupMessageForm(null, campaignId);
					});
					$('#btnDelete').click(function() {
						var checked_checkboxes = $('.icheck-input:checked');
						if (checked_checkboxes.length == 0) {
							alert('Please select messages to delete');
							return false;
						}
						var response = confirm('Are you sure you want to delete the selected messages?');
						if (response == false) return false;
						checked_checkboxes.each(function(index) {
							deleteCampaignMessages($(this).attr('id'), campaignId);
						});
					});
					$('#btnListCampaigns').click(function() {
						getAllCampaigns();
					});
				}
				
				var messageDatatableSettings = function() {
					var oTable = $('#tblMessages').dataTable( {
					    "bRetrieve": true,
				    	"sDom": "<'row dt-rt'<'col-sm-6'l><'col-sm-6'f>r>t<'row dt-rt'<'col-sm-6'i><'col-sm-6'p>>",
				        'sPaginationType': 'bootstrap',
						'aoColumnDefs': [
						                 { 'bVisible': false, 'aTargets': [ 3 ] },
						                 { "bSortable": false, "aTargets": [ 0, 2, 3, 4 ] }
						],
				        "aaSorting": [[1, 'asc']],
				        "iDisplayLength": 10
				    });
				    
					$('.dataTables_filter input').prop ('placeholder', 'Search...');
				    
				    $('tfoot input').keyup(function() {
				    	oTable.fnFilter(this.value, $('tfoot input').index(this));
				    });		
					$('.icheck-input').iCheck({
						checkboxClass: 'icheckbox_minimal-blue',
						radioClass: 'iradio_minimal-blue'
					});
				     
				    /* Add event listener for opening and closing details
				     * Note that the indicator for showing which row is open is not controlled by DataTables,
				     * rather it is done here*/
				     
				    $('.view-more').click(function () {
				        var nTr = $(this).parents('tr')[0];
				        if ( oTable.fnIsOpen(nTr) )
				        { 
				            $(this).attr('class', 'fa fa-plus-circle fa-lg');
				            oTable.fnClose( nTr );
				        }
				        else
				        { 
				        	$(this).attr('class', 'fa fa-minus-circle fa-lg');
				            oTable.fnOpen( nTr, createCampaignHiddenDetails(oTable, nTr), 'details' );
				        }
				    });
					$.extend( $.fn.dataTableExt.oStdClasses, {
					    "sSortAsc": "header headerSortDown",
					    "sSortDesc": "header headerSortUp",
					    "sSortable": "header"
					} );
				}
				
				var createMessageHiddenDetails = function(oTable, nTr) {
					var aData = oTable.fnGetData( nTr );
				    var sOut = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">';
				    sOut += '<tr><td>ID:</td><td>'+aData[4]+'</td></tr>';
				    sOut += '<tr><td>Description:</td><td>'+aData[3]+'</td></tr>';
				    sOut += '</table>';
				    return sOut;
				}
				
				var setupMessageForm = function(message, campaignId) {
					$('#portlet-main-content').html(
							'<form id="frmMessage" class="form" role="form">' +
								'<div class="form-group"><label for="message">Message</label><input type="text" name="message" id="message" class="form-control"></div>' +
								'<div class="form-group"><label for="description">Description</label><textarea name="description" id="description" class="form-control tinymce" rows="5"></textarea></div>' +
								'<div class="form-group"></div>' +
							'</form>');
					applyTinyMCE();
					deactivateMenuButtons();
					if (message != null) {
						$('#message').val(message[0]);
						$('#description').val(message[1]);
						$('#frmMessage div:last').html('<button type="submit" id="btnUpdate" class="btn btn-primary">Update</button>');
					} else {
						$('#frmMessage div:last').html('<button type="submit" id="btnSave" class="btn btn-primary">Save</button>');
					}
					$('#btnSave').click(function() {
						$('#frmMessage').validate({
							rules: {
								message: 'required'
							},
							submitHandler: function() {
								if ($('#description').val().trim() == '') {
									toastr.error('Message description cannot be null');
									return false;
								}
								console.log('Saving a campaign message ...');
								$.ajax({
									type: 'POST',
									contentType: 'application/json',
									url: rootURL + 'campaign/' + campaignId + '/message',
									dataType: 'json',
									data: messageFormToJSON(null),
									statusCode : {
										201: function() {
											toastr.success('Message saved Successfully');
											clearInput();
										}
									}
								});
							},
							invalidHandler: function(event, validator) {
								displayFormInputError(event, validator);
							}
						});
					});
					$('#btnUpdate').click(function() {
						$('#frmMessage').validate({
							rules: {
								message: 'required'
							},
							submitHandler: function() {
								if ($('#description').val().trim() == '') {
									toastr.error('Message description cannot be null');
									return false;
								}
								console.log('Updating a message with id ' + message[2]);
								$.ajax({
									type: 'PUT',
									contentType: 'application/json',
									url: rootURL + 'campaign/message/' + message[2],
									dataType: 'json',
									data: messageFormToJSON(),
									statusCode: {
										200: function() {
											toastr.success('Message updated Successfully');
										}
									}
								});
							},
							invalidHandler: function(event, validator) {
								displayFormInputError(event, validator);
							}
						});
					});
					$('#btnListMessages').click(function() {
						getAllCampaignMessages(campaignId);
					});
					$('#btnListCampaigns').click(function() {
						getAllCampaigns();
					});
				}
				
				var messageFormToJSON = function(messageId) {
					return JSON.stringify({
						id: messageId,
						item: $('#message').val().trim(),
						description: $('#description').val().trim()
					});
				}
				
				var deleteCampaignMessages = function(messageId, campaignId) {
					$.ajax({
						type: 'DELETE',
						url: rootURL + 'campaign/message/' + messageId,
						statusCode: {
							200: function() {
								getAllCampaignMessages(campaignId);
							},
							500: function() {
								toastr.error('Error deleting a message');
							}
						}
					});
				}
			});
		
		</script>
	</body>
</html>